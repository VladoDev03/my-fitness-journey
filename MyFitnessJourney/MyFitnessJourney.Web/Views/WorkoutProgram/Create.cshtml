@model List<MyFitnessJourney.Web.Models.Exercise.ExerciseViewModel>

@{
    ViewData["Title"] = "Create Training Program";

    string exercisesJson = System.Text.Json.JsonSerializer.Serialize(Model.Select(x => new { id = x.Id, name = x.CapitalizedName }).ToList());
}

<h2>@ViewData["Title"]</h2>

<div id="exercisesData" data-exercises='@exercisesJson'></div>

<form asp-action="Create" method="post" id="trainingForm">
    <div id="daysContainer">
        <div class="day-block" data-day-index="0" style="border:1px solid #ccc; padding:10px; margin-bottom:15px;">
            <h3>Day 1</h3>

            <input type="hidden" name="Days[0].DayName" value="Day 1" />

            <div class="exercisesContainer">
                <div class="exercise-row" style="margin-bottom:10px;">
                    <select class="exerciseSelect" name="Days[0].Exercises[0].Name" required>
                        <option value="">-- Select Exercise --</option>
                        @foreach (var exercise in Model)
                        {
                            <option value="@exercise.CapitalizedName" data-id="@exercise.Id">@exercise.CapitalizedName</option>
                        }
                    </select>

                    <input type="hidden" name="Days[0].Exercises[0].ExerciseId" value="" class="exerciseIdInput" />

                    <input type="number" name="Days[0].Exercises[0].Sets" min="1" placeholder="Sets" required style="width:70px; margin-left:5px;" />
                    <input type="number" name="Days[0].Exercises[0].RepsMin" min="1" placeholder="Min Reps" required style="width:70px; margin-left:5px;" />
                    <input type="number" name="Days[0].Exercises[0].RepsMax" min="1" placeholder="Max Reps" required style="width:70px; margin-left:5px;" />

                    <button type="button" class="removeExerciseBtn" style="margin-left: 10px; color: red;">Remove Exercise</button>
                </div>
            </div>

            <button type="button" class="addExerciseBtn" style="margin-top:5px;">Add Exercise</button>
            <button type="button" class="removeDayBtn" style="margin-left: 10px; color: red;">Remove Day</button>
        </div>
    </div>

    <button type="button" id="addDayBtn" style="margin-top:10px;">Add Day</button>

    <br /><br />
    <button type="submit">Save Program</button>
</form>

@section Scripts {
    <script>
        (function () {
            const maxDays = 7;
            let dayIndex = 1;

            const exercisesDataDiv = document.getElementById('exercisesData');
            const exercises = JSON.parse(exercisesDataDiv.dataset.exercises);

            const daysContainer = document.getElementById('daysContainer');
            const addDayBtn = document.getElementById('addDayBtn');

            function updateExerciseIds() {
                const selects = document.querySelectorAll('.exerciseSelect');
                selects.forEach(select => {
                    const selectedOption = select.options[select.selectedIndex];
                    const exerciseIdInput = select.parentElement.querySelector('.exerciseIdInput');
                    exerciseIdInput.value = selectedOption ? selectedOption.dataset.id || '' : '';
                });
            }

            function addExercise(dayBlock, dayIdx) {
                const exercisesContainer = dayBlock.querySelector('.exercisesContainer');
                const exerciseCount = exercisesContainer.querySelectorAll('.exercise-row').length;

                const div = document.createElement('div');
                div.classList.add('exercise-row');
                div.style.marginBottom = '10px';

                const select = document.createElement('select');
                select.classList.add('exerciseSelect');
                select.name = `Days[${dayIdx}].Exercises[${exerciseCount}].Name`;
                select.required = true;

                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.text = "-- Select Exercise --";
                select.appendChild(defaultOption);

                exercises.forEach(ex => {
                    const option = document.createElement('option');
                    option.value = ex.name;
                    option.text = ex.name;
                    option.dataset.id = ex.id;
                    select.appendChild(option);
                });

                const exerciseIdInput = document.createElement('input');
                exerciseIdInput.type = 'hidden';
                exerciseIdInput.name = `Days[${dayIdx}].Exercises[${exerciseCount}].ExerciseId`;
                exerciseIdInput.classList.add('exerciseIdInput');
                exerciseIdInput.value = "";

                const setsInput = document.createElement('input');
                setsInput.type = 'number';
                setsInput.name = `Days[${dayIdx}].Exercises[${exerciseCount}].Sets`;
                setsInput.min = 1;
                setsInput.placeholder = 'Sets';
                setsInput.required = true;
                setsInput.style.width = '70px';
                setsInput.style.marginLeft = '5px';

                const repsMinInput = document.createElement('input');
                repsMinInput.type = 'number';
                repsMinInput.name = `Days[${dayIdx}].Exercises[${exerciseCount}].RepsMin`;
                repsMinInput.min = 1;
                repsMinInput.placeholder = 'Min Reps';
                repsMinInput.required = true;
                repsMinInput.style.width = '70px';
                repsMinInput.style.marginLeft = '5px';

                const repsMaxInput = document.createElement('input');
                repsMaxInput.type = 'number';
                repsMaxInput.name = `Days[${dayIdx}].Exercises[${exerciseCount}].RepsMax`;
                repsMaxInput.min = 1;
                repsMaxInput.placeholder = 'Max Reps';
                repsMaxInput.required = true;
                repsMaxInput.style.width = '70px';
                repsMaxInput.style.marginLeft = '5px';

                const removeExerciseBtn = document.createElement('button');
                removeExerciseBtn.type = 'button';
                removeExerciseBtn.classList.add('removeExerciseBtn');
                removeExerciseBtn.style.marginLeft = '10px';
                removeExerciseBtn.style.color = 'red';
                removeExerciseBtn.textContent = 'Remove Exercise';

                select.addEventListener('change', updateExerciseIds);

                div.appendChild(select);
                div.appendChild(exerciseIdInput);
                div.appendChild(setsInput);
                div.appendChild(repsMinInput);
                div.appendChild(repsMaxInput);
                div.appendChild(removeExerciseBtn);

                exercisesContainer.appendChild(div);
            }

            function updateDayNamesAndIndexes() {
                const dayBlocks = daysContainer.querySelectorAll('.day-block');
                dayBlocks.forEach((dayBlock, index) => {
                    dayBlock.dataset.dayIndex = index;

                    const heading = dayBlock.querySelector('h3');
                    if (heading) {
                        heading.textContent = `Day ${index + 1}`;
                    }

                    let hiddenDayNameInput = dayBlock.querySelector('input[name$=".DayName"]');
                    if (!hiddenDayNameInput) {
                        hiddenDayNameInput = document.createElement('input');
                        hiddenDayNameInput.type = 'hidden';
                        dayBlock.appendChild(hiddenDayNameInput);
                    }
                    hiddenDayNameInput.name = `Days[${index}].DayName`;
                    hiddenDayNameInput.value = `Day ${index + 1}`;

                    const exercisesContainer = dayBlock.querySelector('.exercisesContainer');
                    const exerciseRows = exercisesContainer.querySelectorAll('.exercise-row');

                    exerciseRows.forEach((exerciseRow, exIndex) => {
                        const inputs = exerciseRow.querySelectorAll('select, input');
                        inputs.forEach(input => {
                            const name = input.name;
                            const newName = name.replace(/Days\[\d+\]\.Exercises\[\d+\]/, `Days[${index}].Exercises[${exIndex}]`);
                            input.name = newName;
                        });
                    });
                });

                dayIndex = dayBlocks.length;
                updateExerciseIds();
            }

            function addDay() {
                if (dayIndex >= maxDays) {
                    alert("Maximum 7 days allowed.");
                    return;
                }

                const dayDiv = document.createElement('div');
                dayDiv.classList.add('day-block');
                dayDiv.dataset.dayIndex = dayIndex;
                dayDiv.style.border = "1px solid #ccc";
                dayDiv.style.padding = "10px";
                dayDiv.style.marginBottom = "15px";

                const heading = document.createElement('h3');
                heading.textContent = `Day ${dayIndex + 1}`;
                dayDiv.appendChild(heading);

                const hiddenDayNameInput = document.createElement('input');
                hiddenDayNameInput.type = 'hidden';
                hiddenDayNameInput.name = `Days[${dayIndex}].DayName`;
                hiddenDayNameInput.value = `Day ${dayIndex + 1}`;
                dayDiv.appendChild(hiddenDayNameInput);

                const exercisesContainer = document.createElement('div');
                exercisesContainer.classList.add('exercisesContainer');
                dayDiv.appendChild(exercisesContainer);

                addExercise(dayDiv, dayIndex);

                const addExerciseBtn = document.createElement('button');
                addExerciseBtn.type = 'button';
                addExerciseBtn.classList.add('addExerciseBtn');
                addExerciseBtn.textContent = 'Add Exercise';
                addExerciseBtn.style.marginTop = '5px';
                dayDiv.appendChild(addExerciseBtn);

                const removeDayBtn = document.createElement('button');
                removeDayBtn.type = 'button';
                removeDayBtn.classList.add('removeDayBtn');
                removeDayBtn.textContent = 'Remove Day';
                removeDayBtn.style.marginLeft = '10px';
                removeDayBtn.style.color = 'red';
                dayDiv.appendChild(removeDayBtn);

                daysContainer.appendChild(dayDiv);
                dayIndex++;
                updateExerciseIds();
            }

            addDayBtn.addEventListener('click', addDay);

            daysContainer.addEventListener('change', function (e) {
                if (e.target.classList.contains('exerciseSelect')) {
                    updateExerciseIds();
                }
            });

            daysContainer.addEventListener('click', function (e) {
                if (e.target.classList.contains('removeExerciseBtn')) {
                    e.target.closest('.exercise-row').remove();
                    updateDayNamesAndIndexes();
                }
                if (e.target.classList.contains('removeDayBtn')) {
                    if (confirm("Are you sure you want to remove this day?")) {
                        e.target.closest('.day-block').remove();
                        updateDayNamesAndIndexes();
                    }
                }
                if (e.target.classList.contains('addExerciseBtn')) {
                    const dayBlock = e.target.closest('.day-block');
                    const dayIdx = parseInt(dayBlock.dataset.dayIndex);
                    addExercise(dayBlock, dayIdx);
                }
            });

            document.querySelectorAll('.exerciseSelect').forEach(select => {
                select.addEventListener('change', updateExerciseIds);
            });

            updateDayNamesAndIndexes();
        })();
    </script>
}
